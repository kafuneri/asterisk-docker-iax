[general]
static=yes
writeprotect=no

; --- Outbound Context (Calls from IAX2 Client) ---
; --- 呼出路由 (处理来自 IAX2 软电话的呼叫) ---
[from-internal]
exten => _X.,1,NoOp(Call out from IAX2 client to ${EXTEN})
same => n,Dial(Quectel/quectel0/${EXTEN})
same => n,Hangup()

; --- Inbound Context (Voice + SMS) ---
; --- 统一呼入路由 (语音通话 + 短信接收) ---
[incoming-mobile]

; 1. Voice Call Handling
; 1. 语音呼入处理
exten => s,1,NoOp(Incoming Call from ${CALLERID(num)})
; Generate Call Notification File
; 生成来电通知文件
same => n,Set(CALL_FILE=/var/log/asterisk/unread_sms/call_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}_${CALLERID(num)}.req)
same => n,Set(FILE(${CALL_FILE})=TYPE:IN|NUM:${CALLERID(num)}|TIME:${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
; Dial IAX2 Client (Using Placeholder for Environment Injection)
; 转接 IAX2 客户端 (使用占位符，启动时由环境变量注入)
same => n,Dial(IAX2/__IAX_USER__,30)
same => n,Hangup()

; 2. Hangup Logic
; 2. 挂断处理逻辑
exten => h,1,NoOp(Checking Hangup Source)
; Logic: If SMS_FLAG is set, skip hangup notification to avoid duplicates
; 逻辑：如果检测到 SMS_FLAG 标记，说明是短信通道结束，跳过挂断通知，防止误报
same => n,GotoIf($["${SMS_FLAG}"="1"]?end)
; ---------------------
same => n,NoOp(Call Hangup Processing)
same => n,Set(HUP_FILE=/var/log/asterisk/unread_sms/call_${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}_hangup.req)
same => n,Set(FILE(${HUP_FILE})=TYPE:UP|NUM:${CALLERID(num)}|TIME:${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
same => n(end),NoOp(Hangup Logic Finished)

; 3. SMS Handling
; 3. 短信接收处理
exten => sms,1,NoOp(Incoming SMS from ${CALLERID(num)})
; Flag: Mark this channel as SMS to bypass hangup notification
; 标记：设置 SMS_FLAG 为 1，告知 Hangup 逻辑忽略此通道
same => n,Set(SMS_FLAG=1)
; ---------------------
same => n,Set(SMS_FILE=/var/log/asterisk/unread_sms/${STRFTIME(${EPOCH},,%Y%m%d%H%M%S)}-${CALLERID(num)}.txt)
same => n,Set(FILE(${SMS_FILE})=From: ${CALLERID(num)}${NEWLINE}Content: ${BASE64_DECODE(${SMS_BASE64})})
same => n,Hangup()